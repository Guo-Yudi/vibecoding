<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI Travel Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main-style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form-styles.css') }}">
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=l8IZzVxMX1Pc882f2NEcZI6AsnlYysZl"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/map_init.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/aiwindow-style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
</head>
<body>
    <div id="header">
        <h1>AI Travel Planner</h1>
    </div>
    <div id="main-content">
        <div id="left-panel">
            <h2>åŠŸèƒ½åˆ—è¡¨</h2>
            <div class="control-group">
                <button id="locate-btn" class="btn">å®šä½åˆ°å½“å‰ä½ç½®</button>
                <button id="mic-btn" class="btn" type="button">è¯­éŸ³è¾“å…¥</button>
            </div>
            <section class="card">
                <form class="form" id="plan-form" method="POST" action="/generate">
                <div class="form-grid">
                    <div class="field">
                    <label for="city">ç›®çš„åœ°</label>
                    <input id="city" name="city" type="text" placeholder="e.g., Paris" required />
                    </div>

                    <div class="field">
                    <label for="days">å¤©æ•°</label>
                    <input id="days" name="days" type="number" min="1" max="21" placeholder="3" />
                    </div>

                    <div class="field">
                    <label for="budget">é¢„ç®—</label>
                    <input id="budget" name="budget" type="text" placeholder="e.g., 1000-2000" required />
                    </div>

                    <div class="field">
                    <label for="people">äººæ•°ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="people" name="people" type="number" min="1" max="12" placeholder="1" />
                    </div>

                    <div class="field">
                    <label for="dietary">é¥®é£Ÿåå¥½ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="dietary" name="dietary" type="text" placeholder="ç´ é£Ÿ, æ¸…çœŸ, ç´ é£Ÿ, æ— " />
                    </div>

                    <div class="field field-full">
                    <label for="interests">å…´è¶£çˆ±å¥½ï¼ˆå¯é€‰ï¼‰</label>
                    <input
                        id="interests"
                        name="interests"
                        type="text"
                        placeholder="history, street food, museums, hidden gems"
                    />
                    </div>
                </div>

                <button class="btn" type="submit">ç”Ÿæˆ</button>
                </form>
            </section>
        </div>
        <div id="container"></div>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div id="result-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="result-text"></div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”»å¼¹çª— -->
    <div id="loader-modal" class="modal-overlay">
        <div class="loader"></div>
    </div>

    <!-- Speech Input Modal -->
    <div id="speech-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>è¯·è¯´å‡ºæ‚¨çš„æ—…è¡Œè®¡åˆ’</h2>
            <div id="speech-feedback" class="speech-feedback-container" style="display: block;">
                <p id="speech-text" class="speech-text">æ­£åœ¨ç­‰å¾…è¯­éŸ³...</p>
            </div>
            <button id="finish-speech-btn" class="btn">å®Œæˆ</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (existing code for form submission and modal)

            const micBtn = document.getElementById('mic-btn');
            const speechModal = document.getElementById('speech-modal');
            const speechText = document.getElementById('speech-text');
            const finishSpeechBtn = document.getElementById('finish-speech-btn');

            let mediaRecorder;
            let socket;
            let isRecording = false;
            let finalRecognizedText = "";

            micBtn.addEventListener('click', () => {
                speechModal.style.display = 'flex';
                startRecording();
            });

            finishSpeechBtn.addEventListener('click', () => {
                stopRecording();
                speechModal.style.display = 'none';
                if (finalRecognizedText) {
                    extractInfoFromText(finalRecognizedText);
                }
            });

            function startRecording() {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        isRecording = true;
                        finalRecognizedText = "";
                        speechText.textContent = 'æ­£åœ¨è†å¬...';
                        micBtn.textContent = 'ğŸ›‘';

                        mediaRecorder = new MediaRecorder(stream);
                        const wsUrl = `ws://${window.location.host}/speech-to-text`;
                        socket = new WebSocket(wsUrl);

                        socket.onopen = () => {
                            console.log("WebSocket connection established.");
                            mediaRecorder.start(1280); // Send data every 1.28s
                        };

                        mediaRecorder.ondataavailable = event => {
                            if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                                socket.send(event.data);
                            }
                        };

                        socket.onmessage = event => {
                            const data = JSON.parse(event.data);
                            if (data.error) {
                                console.error("WebSocket Error:", data.error);
                                speechText.textContent = `é”™è¯¯: ${data.error}`;
                            } else if (data.intermediate_result) {
                                speechText.textContent = data.intermediate_result;
                            } else if (data.final_text) {
                                speechText.textContent = data.final_text;
                                finalRecognizedText = data.final_text;
                            }
                        };

                        socket.onerror = error => {
                            console.error("WebSocket Error:", error);
                            speechText.textContent = 'WebSocket è¿æ¥é”™è¯¯ã€‚';
                            isRecording = false;
                            micBtn.textContent = 'ğŸ¤';
                        };

                        socket.onclose = () => {
                            console.log("WebSocket connection closed.");
                            isRecording = false;
                            micBtn.textContent = 'ğŸ¤';
                        };

                    })
                    .catch(err => {
                        console.error("Error getting user media:", err);
                        alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚");
                        speechModal.style.display = 'none';
                    });
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.close();
                }
                isRecording = false;
                micBtn.textContent = 'ğŸ¤';
            }

            function extractInfoFromText(text) {
                document.getElementById('loader-modal').style.display = 'flex';
                fetch('/extract-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text }),
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loader-modal').style.display = 'none';
                    if (data.error) {
                        alert(`ä¿¡æ¯æå–å¤±è´¥: ${data.error}`);
                    } else if (data.extracted_info) {
                        fillForm(data.extracted_info);
                    }
                })
                .catch(error => {
                    document.getElementById('loader-modal').style.display = 'none';
                    console.error('Error during extraction:', error);
                    alert('æå–ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯ã€‚');
                });
            }

            function fillForm(info) {
                for (const key in info) {
                    if (info[key] && document.getElementById(key)) {
                        document.getElementById(key).value = info[key];
                    }
                }
                alert("å·²æ ¹æ®æ‚¨çš„è¯­éŸ³è¾“å…¥è‡ªåŠ¨å¡«å……è¡¨å•ï¼");
            }
        });
    </script>
</body>
</html>